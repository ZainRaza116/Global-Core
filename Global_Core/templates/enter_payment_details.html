{% extends "admin/base.html" %}
{% load static %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link href="https://netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
    <style>
        *{
    padding: 0;
    margin: 0;
    box-sizing: border-box;
}

.main{
    display: flex;
    /*flex-direction: column;*/
    align-items: center;
    justify-content: center;
    padding: 20px 0px;
    font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
}

.invoice{
    width: 70%;
    box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px;
    padding: 50px 0;
    position: relative;
}

.invoice .header{
    display: flex;
    justify-content: space-between;
    padding: 0 50px;
}

.invoice .header div{
    width: 100%;
}

.invoice .header .header-right{
    display: flex;
    flex-direction: column;
}

/* =============================content1 */
.invoice .content1{
    display: flex;
    justify-content: space-between;
    padding: 20px;
    background-color: #79aec831;
    margin: 20px 50px;
    margin-top: 50px;
    border-radius: 5px;
    padding-bottom: 13px;
}

.invoice .content1 .table{
    width: 250px;
    font-size: 14px;
}

.invoice .content1 .table td {
    text-align: right;
}

/* =============================content2 */
.invoice .content2{
    padding: 20px 50px;
    display: flex;
    justify-content: end;
}

.invoice .content2 .amount{
    width: 200px;
    padding: 20px;
    background-color: #79aec831;
    border-radius: 5px;
}


/* =============================content3 */

.invoice .content3{
    padding: 10px 50px;
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 15px;
    margin-top: 20px;
}

.invoice .content3 .select-input{
    height: 30px;
    padding: 5px;
    border: 1px solid rgba(0, 0, 0, 0.162);
    border-radius: 5px;
    font-size: 12px;
    font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
}

.invoice .content3 .select-input:focus{
    outline: 1px solid #79aec831;
}


.invoice .btn-box{
    display: flex;
    justify-content: center;
    margin-top: 30px;
}

.invoice .btn-box button{
    padding: 10px;
    cursor: pointer;
    border: 1px solid gray;
    border-radius: 5px;
    background-color: #79aec831;
    width: 120px;
    font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;

}

.invoice .btn-box button:hover{
    scale: 1.02;
}

.invoice .btn-box button:active{
    scale: 0.98;
}

.invoice .btn-box #getDetailsButton {
            height: max-content;
            border-bottom: 1px solid #4D66F1;
            color: #4D66F1;
            position: absolute;
            right: 50px;
        }

        .invoice .btn-box .icon-link {
            margin-top: 5px !important;
        }

.header-right-box{
    width: max-content !important;
}



@media screen and (max-width: 950px) {
    .invoice{
        width: 90%;
        box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px;
        padding: 50px 0;
    }
}

@media screen and (max-width: 700px) {
    .invoice .content3{
        padding: 10px 50px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }
}

        .c-container {
  max-width: 27rem;
  margin: 1rem auto 0;
  padding: 1rem;
}

        .o-circle {
  display: flex;
  width: 10.555rem; height: 10.555rem;
  justify-content: center;
  align-items: flex-start;
  border-radius: 50%;
  animation: circle-appearance .8s ease-in-out 1 forwards, set-overflow .1s 1.1s forwards;
}

.c-container__circle {
  margin: 0 auto 5.5rem;
}

/*=======================
    C-Circle Sign
=========================*/

.o-circle__sign {
  position: relative;
  opacity: 0;
  background: #fff;
  animation-duration: .8s;
  animation-delay: .2s;
  animation-timing-function: ease-in-out;
  animation-iteration-count: 1;
  animation-fill-mode: forwards;
}

.o-circle__sign::before,
.o-circle__sign::after {
  content: "";
  position: absolute;
  background: inherit;
}

.o-circle__sign::after {
  left: 100%; top: 0%;
  width: 500%; height: 95%;
  transform: translateY(4%) rotate(0deg);
  border-radius: 0;
  opacity: 0;
  animation: set-shaddow 0s 1.13s ease-in-out forwards;
  z-index: -1;
}


/*=======================
      Sign Success
=========================*/

.o-circle__sign--success {
  background: rgb(56, 176, 131);
}

.o-circle__sign--success .o-circle__sign {
  width: 1rem; height: 6rem;
  border-radius: 50% 50% 50% 0% / 10%;
  transform: translateX(130%) translateY(35%) rotate(45deg) scale(.11);
  animation-name: success-sign-appearance;
}

.o-circle__sign--success .o-circle__sign::before {
   bottom: -17%;
   width: 100%; height: 50%;
   transform: translateX(-130%) rotate(90deg);
   border-radius: 50% 50% 50% 50% / 20%;

}

/*--shadow--*/
.o-circle__sign--success .o-circle__sign::after {
   background: rgb(40, 128, 96);
}


/*=======================
      Sign Failure
=========================*/

.o-circle__sign--failure {
  background: rgb(236, 78, 75);
}

.o-circle__sign--failure .o-circle__sign {
  width: 1rem; height: 7rem;
  transform: translateY(25%) rotate(45deg) scale(.1);
  border-radius: 50% 50% 50% 50% / 10%;
  animation-name: failure-sign-appearance;
}

.o-circle__sign--failure .o-circle__sign::before {
   top: 50%;
   width: 100%; height: 100%;
   transform: translateY(-50%) rotate(90deg);
   border-radius: inherit;
}

/*--shadow--*/
.o-circle__sign--failure .o-circle__sign::after {
   background: rgba(175, 57, 55, .8);
}


/*-----------------------
      @Keyframes
--------------------------*/

/*CIRCLE*/
@keyframes circle-appearance {
  0% { transform: scale(0); }

  50% { transform: scale(1.5); }

  60% { transform: scale(1); }

  100% { transform: scale(1); }
}

/*SIGN*/
@keyframes failure-sign-appearance {
  50% { opacity: 1;  transform: translateY(25%) rotate(45deg) scale(1.7); }

  100% { opacity: 1; transform: translateY(25%) rotate(45deg) scale(1); }
}

@keyframes success-sign-appearance {
  50% { opacity: 1;  transform: translateX(130%) translateY(35%) rotate(45deg) scale(1.7); }

  100% { opacity: 1; transform: translateX(130%) translateY(35%) rotate(45deg) scale(1); }
}


@keyframes set-shaddow {
  to { opacity: 1; }
}

@keyframes set-overflow {
  to { overflow: hidden; }
}



/*+++++++++++++++++++
    @Media Queries
+++++++++++++++++++++*/

@media screen and (min-width: 1300px) {

  HTML { font-size: 1.5625em; } /* 25 / 16 = 1.5625 */

}

        .success-animation { margin:150px auto; display: none}

.checkmark {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    display: block;
    stroke-width: 2;
    stroke: #4bb71b;
    stroke-miterlimit: 10;
    box-shadow: inset 0px 0px 0px #4bb71b;
    animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
    position:relative;
    top: 5px;
    right: 5px;
   margin: 0 auto;
}
.checkmark__circle {
    stroke-dasharray: 166;
    stroke-dashoffset: 166;
    stroke-width: 2;
    stroke-miterlimit: 10;
    stroke: #4bb71b;
    fill: #fff;
    animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;

}

.checkmark__check {
    transform-origin: 50% 50%;
    stroke-dasharray: 48;
    stroke-dashoffset: 48;
    animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
}

@keyframes stroke {
    100% {
        stroke-dashoffset: 0;
    }
}

@keyframes scale {
    0%, 100% {
        transform: none;
    }

    50% {
        transform: scale3d(1.1, 1.1, 1);
    }
}

@keyframes fill {
    100% {
        box-shadow: inset 0px 0px 0px 30px #4bb71b;
    }
}
.alert-box{
    position: fixed;
    z-index: 999;
    top: -40px;
    width: 80%;
    background-color: #ff5353;
    height: 40px;
    border-radius: 5px;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: bold;
    transition: 0.2s all ease-in;
}
    </style>
</head>
<form id="paymentForm" method="POST">
    {% csrf_token %}
    <div id="main" class="main">
        <div class="invoice">
            <div class="header">
                <div style="display: flex; flex-direction: column; gap: 5px">
                    <p style="font-size: 20px; font-weight: 600;">Personal Detail</p>
                    <p style="font-size: 14px; margin-top: 10px;">
                        <b>Name: </b>{{ client_info.customer_name }}
                    </p>
                    <p style="font-size: 14px;">
                        <b>Address</b>
                        <p style="margin-top: -10px; width: 300px; font-size: 14px">{{ client_info.customer_address }}</p>
                    </p>
                    <p style="font-size: 14px; margin-top: 10px;">
                        <b>Email: </b>{{ client_info.customer_email }}
                    </p>
                </div>
                            {% if account %}
                <div class="header-right" style="display: flex; flex-direction: column; align-items: end;">
                    <p style="font-size: 20px; font-weight: 600; margin-right: 40px">Account Detail</p>
                    <div class="header-right-box">
                        <p style="font-size: 14px; margin-top: 10px;">
                            <b>Account Name: </b>{{ account.account_name }}
                        </p>
                        <p style="font-size: 14px;">
                            <b>Checking Account: </b>{{ account.checking_acc }}
                        </p>
                        <p style="font-size: 14px;">
                            <b>Routing #: </b>{{ account.routing_no }}
                        </p>
                        <p style="font-size: 14px;">
                            <b>Checking No: </b>{{ account.checking_no }}
                        </p>
                        <p style="font-size: 14px;">
                            <b>Account Address: </b>
                        <p style="margin-top: -10px; width: 300px; font-size: 14px">{{ account.account_address }}</p>
                        </p>
                    </div>
                </div>

            </div>

                <div class="content1">
                    <div>
                        <p style="font-size: 14px; font-weight: 600;">Basic Tech. Services</p>
                    </div>
                    <div>
                        <p style="font-size: 14px; font-weight: 600;">${{ client_info.amount }}</p>
                    </div>
                </div>
            <div class="content2">
                <div class="amount">
                    <p style="font-size: 14px;">Amount Due</p>
                    <p name ="amount" style="text-align: right; font-size: 18px;"><b>${{ client_info.amount }}</b></p>
                </div>
            </div>
            {% else %}
                     {{ cards_data.card_no }}
                <div class="header-right" style="display: flex; flex-direction: column; align-items: end;">
                    <p style="font-size: 20px; font-weight: 600; margin-right: 40px">Account Detail</p>
                    <div class="header-right-box">
                    <p style="font-size: 14px; margin-top: 10px;">
                        <b>Card Number: </b>
                       **** **** **** {{ cards.card_no|slice:"-4:" }}
                    </p>
                    <p style="font-size: 14px;">
                        <b>Expiration Date: </b>
             {{ cards.expiry_month }}/{{ cards.expiry_year }}
                    </p>
                    <p style="font-size: 14px;">
                        <b>CVC</b>
                        XXX
                    </p>
                    <p style="font-size: 14px;">
                        <b>Billing Address</b>
                        <p style="margin-top: -5px; width: 230px; font-size: 14px">  {{ cards.billing_address }}</p>
                    </p>
                    </div>
                </div>
            </div>
            <div class="content1">
                    <p style="font-size: 14px; font-weight: 600;">Basic Tech. Services</p>
                <div>
                    <p style="font-size: 14px; font-weight: 600;"></p>
                </div>
                <div>
                    <p style="font-size: 14px; font-weight: 600;">${{ client_info.amount }}</p>
                </div>
            </div>

<!--            NORMAL CONTENT-->
            <div class="content2">
                <div class="amount">
                    <p style="font-size: 14px;">Amount Due</p>
                    <p name ="amount" style="text-align: right; font-size: 18px;"><b>${{ client_info.amount }}</b></p>
                </div>
            </div>
            <div class="content3">
                <div style="display: flex; flex-direction: column; gap: 5px;">
                        {% if security_option %}
                    <p>Security Option: <span id="security_option">{{ security_option }}</span></p>
                    {% else %}

            <label style="font-size: 14px;">Security Option</label>
            <div style="font-size: 14px;">
                <label><input type="radio" name="security" value="2D" checked>&nbsp;2D secure</label>
                <label><input type="radio" name="security" value="3D">&nbsp;3D secure</label>
            </div>
        </div>
                  {% endif %}
        <div style="display: flex; flex-direction: column; gap: 5px;">
<label style="font-size: 14px;">Sale/Authorize</label>
{% if payment_method %}
    <p name="payment_method"><span id="payment_method">{{ payment_method }}</span></p>
{% else %}
    <select id="sale-authorize-select" class="select-input" name="payment_method">
        <option value="Sale">Sale</option>
        <option value="Authorize">Authorize</option>
    </select>
        </div>
{% endif %}
<div style="display: flex; flex-direction: column; gap: 5px;">
    <label style="font-size: 14px;">Gateway</label>

        <select id="gateway-select" class="select-input" name="gateway">
            <option value="">---Select---</option>
            {% for gateway_option in gateway %}
                <option value="{{ gateway_option.id }},{{ gateway_option.merchant }}">{{ gateway_option.merchant }}</option>
            {% endfor %}
        </select>

</div>
                 <div style="display: flex; flex-direction: column; gap: 5px;">

<label style="font-size: 14px;">Merchant</label>
                      {% if merchant %}
                       <p><span name = "gateway" id="merchant">{{ merchant }}</span></p>
                       {% else %}
<select name ="merchant" id="merchant-select" class="select-input">
    <option  value="">---Select---</option>
</select>
                       {% endif %}
            </div>


        </div>

        <div class="btn-box">
                <button type="submit" onclick={{fn_submit}} id="submitPayment">Submit</button>
            <a id="getDetailsButton" type="submit"><i class="icon-link"></i>
                Generate Link</a>
            </div>

        <div class="toast-container position-fixed top-0 end-0 p-3">
            <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header bg-primary">
                    <strong class="me-auto text-light">Notification</strong>
                    <small class="text-light">0 mins ago</small>
                    <button type="button" class="btn-close text-light" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    Link Copied Successfully
                </div>
            </div>
        </div>
    </div>
    </div>

    <div class="success-animation" id="animatedMessage">
        <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52"><circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none" /><path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8" /></svg>
        <p style="text-align: center; margin-top: 40px">Payment Successful</p>
    </div>

    <div class="alert-box" id="alert-box">
        <p id="errorMessage"></p>
    </div>


</form>

<!--<section class="c-container">-->

<!--  <div class="o-circle c-container__circle o-circle__sign&#45;&#45;success">-->
<!--    <div class="o-circle__sign"></div>-->
<!--  </div>-->
<!--    <div style="text-align: center">Transaction Successfull !</div>-->

<!--  <div class="o-circle c-container__circle o-circle__sign&#45;&#45;failure">-->
<!--    <div class="o-circle__sign"></div>-->
<!--  </div>-->

<!--    <div style="text-align: center">Transaction Fail !</div>-->

<!--</section>-->
    {% endif %}
<script src="https://unpkg.com/axios/dist/axios.min.js"></script> <!-- Include Axios library -->
<script>
    // Function to handle form submission
    function handleSubmit(event) {
        event.preventDefault(); // Prevent default form submission

        // Get form data
        var formData = new FormData(document.getElementById('paymentForm'));
        document.getElementById("submitPayment").innerHTML = "Loading...";
        document.getElementById("submitPayment").disabled = true;
        // Make Axios request
        axios.post('/cms/Global_Core/sales/{{ object_id }}/payment/', formData)
            .then(function (response) {
                // Handle success response
                console.log("==========", response.data); // Log response data to console
                // Display success message to the user
                if(response.data.code == 200){
                    const animatedMessage = document.getElementById("animatedMessage");
                    animatedMessage.style.display = "block";
                    const mainDiv = document.getElementById("main");
                    mainDiv.style.display = "none";
                }else{
                    document.getElementById("submitPayment").innerHTML = "Submit Again";
                    document.getElementById("submitPayment").disabled = false;

                    const alertMessage = document.getElementById("alert-box");
                    alertMessage.style.top = "20px";
                    document.getElementById("errorMessage").innerHTML = "Transaction Failed";
                    setTimeout(() => {
                        const alertMessage = document.getElementById("alert-box");
                        alertMessage.style.top = "-40px";
                    }, 2000)
                }
            })
            .catch(function (error) {
                // Handle error response
                console.error('Error:', error); // Log error to console
                // Display error message to the user

                document.getElementById("submitPayment").innerHTML = "Submit Again";
                document.getElementById("submitPayment").disabled = false;

                const alertMessage = document.getElementById("alert-box");
                alertMessage.style.top = "20px";
                document.getElementById("errorMessage").innerHTML = "Fill all Fields";
                setTimeout(() => {
                    const alertMessage = document.getElementById("alert-box");
                    alertMessage.style.top = "-40px";
                }, 2000)
            });
    }

    // Attach event listener to form submission
    document.getElementById('paymentForm').addEventListener('submit', handleSubmit);
</script>

<script>
    const toastTrigger = document.getElementById('getDetailsButton')
    const toastLiveExample = document.getElementById('liveToast')
    if (toastTrigger) {
        toastTrigger.addEventListener('click', () => {
            const toast = new bootstrap.Toast(toastLiveExample)

            toast.show()
        })
    }
document.getElementById('gateway-select').addEventListener('change', function() {
    var merchantSelect = document.getElementById('merchant-select');
    var selectedValue = this.value;
    var gatewayId = selectedValue.split(',')[0];
    var gatewayName = selectedValue.split(',')[1];

    // Clear existing options
    merchantSelect.innerHTML = '<option value="">---Select---</option>';

    // Fetch merchants for selected gateway using AJAX
    if (gatewayId) {
        // Get CSRF token from cookie
        var csrftoken = getCookie('csrftoken');

fetch('/get_merchants/?gateway_id=' + gatewayId, {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // Add merchants to select dropdown
            data.forEach(function(merchant) {
                var option = document.createElement('option');
                option.text = merchant;
                merchantSelect.add(option);
            });
        })
        .catch(error => {
            console.log('Error fetching merchants:', error);
        });
    }
});


    // Function to get CSRF token from cookie
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }


</script>

<script>
document.getElementById('getDetailsButton').addEventListener('click', function() {
    event.preventDefault();
    const securityOption = document.querySelector('input[name="security"]:checked').value;
    const paymentMethod = document.getElementById('sale-authorize-select').value;
    const gateway = document.getElementById('gateway-select').value;
    const merchant = document.getElementById('merchant-select').value;
    const objectId = '{{ object_id }}';
    console.log(objectId)
    fetch(`http://127.0.0.1:8000/cms/Global_Core/sales/details/?objectId=${objectId}&security=${securityOption}&payment_method=${paymentMethod}&gateway=${gateway}&merchant=${merchant}`)
        .then(response => response.json())
        .then(data => {
            console.log(data);
            const invoiceId = data.invoice_id;
            console.log(invoiceId);

            // Copy invoice ID to clipboard
            const el = document.createElement('textarea');
            el.value = invoiceId;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            window.location.href = `http://127.0.0.1:8000/customer_invoice/${invoiceId}/`;
        })
        .catch(error => {
            console.error('Error fetching details:', error);
        });
});
</script>


<script>
    document.addEventListener("DOMContentLoaded", function() {


        const securityOptions = document.querySelectorAll('input[name="security"]');
        const saleAuthorizeSelect = document.getElementById("sale-authorize-select");
        saleAuthorizeSelect.selectedIndex = 0;
        securityOptions.forEach(option => {
            option.addEventListener("change", function() {
                if (this.value === "3D") {
                    saleAuthorizeSelect.innerHTML = '<option>Sale</option>';
                } else {
                    saleAuthorizeSelect.innerHTML = '<option>Sale</option><option>Authorize</option>';
                }
            });
        });
    });

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
</body>
</html>
{% endblock %}